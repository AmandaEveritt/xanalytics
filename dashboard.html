<html>
<head>
  <title>{{orgname}} Analytics Dashboard</title>

<!-- DataTables CSS -->
<!--
<link rel="stylesheet" type="text/css" href="//cdn.datatables.net/1.10.3/css/jquery.dataTables.css">
-->
<link rel="stylesheet" type="text/css" href="/css/jquery.dataTables.css">
<link rel="stylesheet" type="text/css" href="/css/dataTables.tableTools.css">
  
<!-- jQuery -->
<script type="text/javascript" charset="utf8" src="//code.jquery.com/jquery-1.10.2.min.js"></script>

<link rel="stylesheet" href="//code.jquery.com/ui/1.11.2/themes/smoothness/jquery-ui.css">
<script type="text/javascript" src="//code.jquery.com/ui/1.11.2/jquery-ui.js"></script>
  
<!-- tooltips -->
<style>
.tooltip{
	/* position: absolute; */
	display: none;
    width: 100px;
	border: 1px solid #333;
	background: #BDCDFF;
	padding: 5px 20px;
	color: #333;
	
	border-radius: 5px;
	-webkit-border-radius: 5px;
	-moz-border-radius: 5px;
}
</style>

<!-- DataTables -->
<script type="text/javascript" charset="utf8" src="/js/jquery.dataTables.js"></script>
<script type="text/javascript" charset="utf8" src="/js/dataTables.tableTools.js"></script>


<!-- highchart -->

<script src="/js/highstock.js"></script>
<script src="/js/highcharts-more.js"></script>
<script src="/js/modules/map.js"></script> 
<script src="/js/modules/data.js"></script> 
<script src="/js/mapdata/world.js"></script>

<!-- ----------------------------------------------------------------------------- -->

  <script type='text/javascript'
     src='https://www.google.com/jsapi'></script>

  <script type='text/javascript'>

  $(document).ready( function () {
    $('#table_id').DataTable({
         dom: 'T<"clear">lfrtip',
         "order": [ 0, 'desc' ],
  }
);

    $('#table_id tbody').on('click', 'tr', function () {
        var name = $('td', this).eq(4).text();
        window.location.href = "/course/" + name;
        // alert( 'You clicked on '+name+'\'s row' );
    } );

} );

</script>

</head>
<body>
  <h1>{{orgname}} Analytics: Cross-Course Dashboard</h1>

[ <a href="/">Course list</a> ]

<span style="float:right; color:blue">{{user}}
{% if is_staff %}
[ <a href="/admin">admin page</a> ]
{% endif %}
</span>

<h2>Geographic Distribution</h2>

<div id="geomap" style="height: 500px; min-width: 310px; max-width: 800px; margin: 0 auto"><img src="/images/loading_icon.gif"/></div>

<div><p>Totals:</p><table id="geo_totals"></p></table></div>

<br/>
<p></p>

<div><p>Top countries by registration:</p><table id="geo_top"></table></div>

<script type="text/javascript">

$(document).ready(function() {

    $.getJSON('/dashboard/get/geo_stats', function (data) {

        var mapData = Highcharts.geojson(Highcharts.maps['custom/world']);

        // Correct UK to GB in data
        $.each(data, function () {
            if (this.code === 'UK') {
                this.code = 'GB';
            }
        });

	// console.log(data['totals']);

	function numberWithCommas(x) {
	    return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
	}

	var table = $('#geo_totals').DataTable({
	    "paging":   false,
	    "ordering": false,
	    "info":     false,
	    "searching":    false,
	    "data": [ data['totals'] ],
	    "columns" : [ {'data': 'nregistered', 'title': "Total # ever registered", "class": "dt-center" },
			  {'data': 'nviewed', 'title': "Total # viewed", "class": "dt-center" },
			  {'data': 'nexplored', 'title': "Total # explored", "class": "dt-center" },
			  {'data': 'ncertified', 'title': "Total # certified", "class": "dt-center" },
			  {'data': 'nverified', 'title': "Total # verified-ID", "class": "dt-center" },
			  ],
	    "columnDefs": [
		{
		    "targets": [ 0, 1, 2, 3, 4 ],
                    "render": function ( data, type, row ) {
			return numberWithCommas(data);   // (eval(data)).toFixed(2);
                    },
		}
	    ],
        });

    $('#geo_totals tbody tr').each( function() {
        var nTds = $('td', this);
	nTds[0].setAttribute('title', 'Ever registered does not subtract those who un-register');
	nTds[1].setAttribute('title', 'Viewed = visited the course registered for, at least once');
	nTds[2].setAttribute('title', 'Explored = visited at least half the chapters of the course');
	nTds[3].setAttribute('title', 'Certified = earned a certificate in the course');
	nTds[4].setAttribute('title', 'Verified-ID = signed up for a paid verified-ID track');
	nTds.tooltip();
    });

	var table = $('#geo_top').DataTable({
            dom: 'T<"clear">lfrtip',
	    "paging":   true,
	    "ordering": true,
	    "info":     true,
	    "searching":    true,
            "order": [ 1, 'desc' ],
	    "data": data['table'],
	    "columns" : [ {'data': 'countryLabel', 'title': "Country Name", "class": "dt-center" },
			  {'data': 'nregistered', 'title': "# registered", "class": "dt-center" },
			  {'data': 'nviewed', 'title': "# viewed", "class": "dt-center" },
			  {'data': 'nexplored', 'title': "# explored", "class": "dt-center" },
			  {'data': 'ncertified', 'title': "# certified", "class": "dt-center" },
			  {'data': 'cert_pct', 'title': "% certified (of registered)", "class": "dt-center" },
			  {'data': 'cert_pct_of_viewed', 'title': "% certified (of viewed)", "class": "dt-center" },
			  // {'data': 'avg_hours_certified', 'title': "avg hours spent on course (certified)", "class": "dt-center" },
			  {'data': 'nverified', 'title': "# verified id", "class": "dt-center" },
			  {'data': 'ncert_verified', 'title': "# verified id certified", "class": "dt-center" },
			  {'data': 'verified_cert_pct', 'title': "% certified (of verified)", "class": "dt-center" },
			  ],
	    "columnDefs": [
		{
		    "targets": [ 1,2,3,4, 7, 8 ],
                    "render": function ( data, type, row ) {
			return numberWithCommas(data);   // (eval(data)).toFixed(2);
                    },
		}
	    ],
        });

    var update_tooltips = function(){
	$('#geo_top tbody tr').each( function() {
            var sTitle;
            var nTds = $('td', this);
            var country = $(nTds[0]).text();
            var registered = $(nTds[1]).text();
            var certified = $(nTds[4]).text();
            var verified = $(nTds[8]).text();
	    var rpct = ((Number(registered.replace(',','')) / Number(data['totals']['nregistered'])) * 100.0).toFixed(2);
	    var vpct = ((Number(verified.replace(',','')) / Number(data['totals']['nverified'])) * 100.0).toFixed(2);
            sTitle = "<table><tr><th colspan='3'>" + country + "</th></tr>";
	    sTitle += "<tr><td># registered</td><td>" + registered + "</td><td>" + rpct +"% of total</td></tr>";
	    sTitle += "<tr><td># verified</td><td>" + verified + "</td><td>" + vpct +"% of total</td></tr>";
	    sTitle += "</table>";
            this.setAttribute( 'title', sTitle );
	} );
    };
	
    update_tooltips();

    $('#geo_top').on( 'draw.dt', function () {     
	update_tooltips();
    });

    /* Apply the tooltips */
    table.$('tr').tooltip( {
        'content': function () {   return $(this).prop('title'); },
        "delay": 0,
        // "track": true,
        // "fade": 250
    } );

	// console.log(data['series'])

        $('#geomap').highcharts('Map', {
            chart : {
                borderWidth : 1
            },

            title: {
                text: 'Enrollment and certification by country (updated ' + data['last_updated']  + ')'
            },
	    credits: {  enabled: false  },

            subtitle : {
                text : 'Bubble size is proportional to registration'
            },

            legend: {
                enabled: false
            },

            mapNavigation: {
                enabled: true,
                buttonOptions: {
                    verticalAlign: 'bottom'
                }
            },

            series : [{
                name: 'Countries',
                mapData: mapData,
                color: '#E0E0E0',
                enableMouseTracking: false
            }, {
                type: 'mapbubble',
                mapData: mapData,
                name: 'Registration and Certification',
                joinBy: ['iso-a2', 'cc'],
                data: data['series'],
                minSize: 4,
                maxSize: '12%',
                tooltip: {
                    pointFormat: '{point.cc}:  {point.name}<br/>{point.z} registered<br/>{point.ncertified} certified<br/>{point.cert_pct} certification %'
                }
            }]
        });

    });
});
</script>


<h2>Course Listings: Total {{ncourses}}</h2>

<h3>Number of courses offered versus time:</h3>
(click and drag to zoom)

<div id="cbytime" style="min-width: 310px; height: 400px; margin: 0 auto"><img src="/images/loading_icon.gif"/></div>

<script type="text/javascript">

$(document).ready(function() {

    $.getJSON('/dashboard/get/courses_by_time', function(data) {

        // Create the chart
//        $('#cbytime').highcharts('StockChart', {
        $('#cbytime').highcharts({

	    chart: { type: 'spline',  zoomType: 'x' },
            rangeSelector : {
                selected : 5
            },
	    credits: {  enabled: false  },
            title : {
                text : 'Number of courses over time (by registration opening date)',
            },

	    xAxis: {
		type: 'datetime',
		dateTimeLabelFormats: { // don't display the dummy year
                    month: '%e. %b',
                    year: '%b'
		},
		title: {
                    text: 'Date'
		}
            },

            series : data['series'],
        }, function(chartObj) {
	});
    });
});
</script>


<h3>Courses which have opened for registration on edX.org:</h3>

{% autoescape off %}{{ table }}{% endautoescape %}

</body>
</html>
